<hr />

<h2 id="prerequisites">Prerequisites</h2>

<ul>
  <li><strong>Rust:</strong> 1.75 or later</li>
  <li><strong>Tokio:</strong> 1.41 or later (async runtime)</li>
  <li><strong>Cargo:</strong> <code class="language-plaintext highlighter-rouge">Rust 2021</code> 1.75+</li>
</ul>

<hr />

<h2 id="installation">Installation</h2>

<p>Add cache-kit to your <code class="language-plaintext highlighter-rouge">Cargo.toml</code>:</p>

<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[dependencies]</span>
<span class="nn">cache-kit</span> <span class="o">=</span> <span class="p">{</span> <span class="py">version</span> <span class="p">=</span> <span class="s">"0.9"</span> <span class="p">}</span>
<span class="nn">serde</span> <span class="o">=</span> <span class="p">{</span> <span class="py">version</span> <span class="p">=</span> <span class="s">"1.0"</span><span class="p">,</span> <span class="py">features</span> <span class="p">=</span> <span class="nn">["derive"]</span> <span class="p">}</span>
<span class="nn">tokio</span> <span class="o">=</span> <span class="p">{</span> <span class="py">version</span> <span class="p">=</span> <span class="s">"1.41"</span><span class="p">,</span> <span class="py">features</span> <span class="p">=</span> <span class="p">[</span><span class="s">"rt"</span><span class="p">,</span> <span class="s">"sync"</span><span class="p">,</span> <span class="s">"macros"</span><span class="p">]</span> <span class="p">}</span>
</code></pre></div></div>

<h3 id="feature-flags">Feature Flags</h3>

<p>cache-kit uses feature flags to enable optional backends:</p>

<table>
  <thead>
    <tr>
      <th>Feature</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">inmemory</code></td>
      <td>In-memory cache backend</td>
      <td>✅ Enabled</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">redis</code></td>
      <td>Redis backend with connection pooling</td>
      <td>❌ Optional</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">memcached</code></td>
      <td>Memcached backend</td>
      <td>❌ Optional</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">all</code></td>
      <td>Enable all backends</td>
      <td>❌ Optional</td>
    </tr>
  </tbody>
</table>

<h3 id="basic-installation-inmemory-only">Basic Installation (InMemory Only)</h3>

<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[dependencies]</span>
<span class="py">cache-kit</span> <span class="p">=</span> <span class="s">"0.9"</span>
</code></pre></div></div>

<p>This provides the InMemory backend, perfect for:</p>

<ul>
  <li>Development</li>
  <li>Testing</li>
  <li>Single-instance services</li>
</ul>

<h3 id="redis-backend">Redis Backend</h3>

<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[dependencies]</span>
<span class="nn">cache-kit</span> <span class="o">=</span> <span class="p">{</span> <span class="py">version</span> <span class="p">=</span> <span class="s">"0.9"</span><span class="p">,</span> <span class="py">features</span> <span class="p">=</span> <span class="nn">["redis"]</span> <span class="p">}</span>
</code></pre></div></div>

<p>Enables production-grade Redis caching with connection pooling.</p>

<h3 id="memcached-backend">Memcached Backend</h3>

<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[dependencies]</span>
<span class="nn">cache-kit</span> <span class="o">=</span> <span class="p">{</span> <span class="py">version</span> <span class="p">=</span> <span class="s">"0.9"</span><span class="p">,</span> <span class="py">features</span> <span class="p">=</span> <span class="nn">["memcached"]</span> <span class="p">}</span>
</code></pre></div></div>

<p>Enables Memcached backend for high-performance distributed caching.</p>

<h3 id="all-backends">All Backends</h3>

<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[dependencies]</span>
<span class="nn">cache-kit</span> <span class="o">=</span> <span class="p">{</span> <span class="py">version</span> <span class="p">=</span> <span class="s">"0.9"</span><span class="p">,</span> <span class="py">features</span> <span class="p">=</span> <span class="nn">["all"]</span> <span class="p">}</span>
</code></pre></div></div>

<p>Enables all available backends. Useful for:</p>

<ul>
  <li>Testing multiple backends</li>
  <li>Switching backends based on environment</li>
  <li>Benchmarking comparisons</li>
</ul>

<hr />

<h2 id="minimal-configuration">Minimal Configuration</h2>

<p>cache-kit requires minimal configuration. Here’s a complete working example:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">use</span> <span class="nn">cache_kit</span><span class="p">::{</span>
    <span class="n">CacheEntity</span><span class="p">,</span> <span class="n">CacheFeed</span><span class="p">,</span> <span class="n">DataRepository</span><span class="p">,</span> <span class="n">CacheExpander</span><span class="p">,</span>
    <span class="nn">backend</span><span class="p">::</span><span class="n">InMemoryBackend</span><span class="p">,</span>
    <span class="nn">strategy</span><span class="p">::</span><span class="n">CacheStrategy</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">use</span> <span class="nn">serde</span><span class="p">::{</span><span class="n">Deserialize</span><span class="p">,</span> <span class="n">Serialize</span><span class="p">};</span>

<span class="nd">#[derive(Clone,</span> <span class="nd">Serialize,</span> <span class="nd">Deserialize)]</span>
<span class="k">struct</span> <span class="n">User</span> <span class="p">{</span>
    <span class="n">id</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span> <span class="n">CacheEntity</span> <span class="k">for</span> <span class="n">User</span> <span class="p">{</span>
    <span class="k">type</span> <span class="n">Key</span> <span class="o">=</span> <span class="nb">String</span><span class="p">;</span>
    <span class="k">fn</span> <span class="nf">cache_key</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span><span class="p">::</span><span class="n">Key</span> <span class="p">{</span> <span class="k">self</span><span class="py">.id</span><span class="nf">.clone</span><span class="p">()</span> <span class="p">}</span>
    <span class="k">fn</span> <span class="nf">cache_prefix</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="k">'static</span> <span class="nb">str</span> <span class="p">{</span> <span class="s">"user"</span> <span class="p">}</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">UserFeeder</span> <span class="p">{</span>
    <span class="n">id</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="n">user</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span> <span class="n">CacheFeed</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="k">for</span> <span class="n">UserFeeder</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">entity_id</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">String</span> <span class="p">{</span> <span class="k">self</span><span class="py">.id</span><span class="nf">.clone</span><span class="p">()</span> <span class="p">}</span>
    <span class="k">fn</span> <span class="nf">feed</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span> <span class="k">self</span><span class="py">.user</span> <span class="o">=</span> <span class="n">entity</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">UserRepository</span><span class="p">;</span>

<span class="k">impl</span> <span class="n">DataRepository</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="k">for</span> <span class="n">UserRepository</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">fetch_by_id</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">id</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">String</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nn">cache_kit</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
        <span class="nf">Ok</span><span class="p">(</span><span class="nf">Some</span><span class="p">(</span><span class="n">User</span> <span class="p">{</span>
            <span class="n">id</span><span class="p">:</span> <span class="n">id</span><span class="nf">.clone</span><span class="p">(),</span>
            <span class="n">name</span><span class="p">:</span> <span class="s">"Alice"</span><span class="nf">.to_string</span><span class="p">(),</span>
        <span class="p">}))</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nd">#[tokio::main]</span>
<span class="k">async</span> <span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span> <span class="nn">std</span><span class="p">::</span><span class="nn">error</span><span class="p">::</span><span class="n">Error</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">backend</span> <span class="o">=</span> <span class="nn">InMemoryBackend</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">expander</span> <span class="o">=</span> <span class="nn">CacheExpander</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">backend</span><span class="p">);</span>
    <span class="k">let</span> <span class="n">repository</span> <span class="o">=</span> <span class="n">UserRepository</span><span class="p">;</span>

    <span class="k">let</span> <span class="k">mut</span> <span class="n">feeder</span> <span class="o">=</span> <span class="n">UserFeeder</span> <span class="p">{</span>
        <span class="n">id</span><span class="p">:</span> <span class="s">"user_001"</span><span class="nf">.to_string</span><span class="p">(),</span>
        <span class="n">user</span><span class="p">:</span> <span class="nb">None</span><span class="p">,</span>
    <span class="p">};</span>

    <span class="n">expander</span><span class="nf">.with</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">feeder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">repository</span><span class="p">,</span> <span class="nn">CacheStrategy</span><span class="p">::</span><span class="n">Refresh</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

    <span class="nd">println!</span><span class="p">(</span><span class="s">"User: {:?}"</span><span class="p">,</span> <span class="n">feeder</span><span class="py">.user</span><span class="p">);</span>
    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="backend-configuration">Backend Configuration</h2>

<h3 id="️-production-backend-requirement">⚠️ Production Backend Requirement</h3>

<p><strong>InMemory backend is for development/testing only.</strong> Use Redis or Memcached for production deployments.</p>

<hr />

<h3 id="inmemory-backend">InMemory Backend</h3>

<p>No configuration required:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">use</span> <span class="nn">cache_kit</span><span class="p">::</span><span class="nn">backend</span><span class="p">::</span><span class="n">InMemoryBackend</span><span class="p">;</span>

<span class="k">let</span> <span class="n">backend</span> <span class="o">=</span> <span class="nn">InMemoryBackend</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
</code></pre></div></div>

<p>The InMemory backend uses <code class="language-plaintext highlighter-rouge">DashMap</code> internally, providing:</p>

<ul>
  <li>Lock-free concurrent HashMap</li>
  <li>Thread-safe operations</li>
  <li>Zero external dependencies</li>
</ul>

<h3 id="redis-backend-1">Redis Backend</h3>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">use</span> <span class="nn">cache_kit</span><span class="p">::</span><span class="nn">backend</span><span class="p">::{</span><span class="n">RedisBackend</span><span class="p">,</span> <span class="n">RedisConfig</span><span class="p">};</span>

<span class="k">let</span> <span class="n">config</span> <span class="o">=</span> <span class="n">RedisConfig</span> <span class="p">{</span>
    <span class="n">url</span><span class="p">:</span> <span class="s">"redis://localhost:6379"</span><span class="nf">.to_string</span><span class="p">(),</span>
    <span class="n">max_connections</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">min_connections</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">connection_timeout_secs</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">let</span> <span class="n">backend</span> <span class="o">=</span> <span class="nn">RedisBackend</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</code></pre></div></div>

<h4 id="redis-configuration-options">Redis Configuration Options</h4>

<table>
  <thead>
    <tr>
      <th>Field</th>
      <th>Type</th>
      <th>Default</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">url</code></td>
      <td><code class="language-plaintext highlighter-rouge">String</code></td>
      <td>Required</td>
      <td>Redis connection URL</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">max_connections</code></td>
      <td><code class="language-plaintext highlighter-rouge">usize</code></td>
      <td><code class="language-plaintext highlighter-rouge">10</code></td>
      <td>Maximum connection pool size</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">min_connections</code></td>
      <td><code class="language-plaintext highlighter-rouge">usize</code></td>
      <td><code class="language-plaintext highlighter-rouge">2</code></td>
      <td>Minimum idle connections</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">connection_timeout_secs</code></td>
      <td><code class="language-plaintext highlighter-rouge">u64</code></td>
      <td><code class="language-plaintext highlighter-rouge">5</code></td>
      <td>Connection timeout in seconds</td>
    </tr>
  </tbody>
</table>

<h4 id="redis-url-formats">Redis URL Formats</h4>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Local Redis</span>
<span class="s">"redis://localhost:6379"</span>

<span class="c1">// Remote Redis with password</span>
<span class="s">"redis://:password@example.com:6379"</span>

<span class="c1">// Redis with specific database</span>
<span class="s">"redis://localhost:6379/1"</span>

<span class="c1">// TLS connection</span>
<span class="s">"rediss://example.com:6379"</span>
</code></pre></div></div>

<h4 id="environment-based-configuration">Environment-Based Configuration</h4>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="n">env</span><span class="p">;</span>

<span class="k">let</span> <span class="n">redis_url</span> <span class="o">=</span> <span class="nn">env</span><span class="p">::</span><span class="nf">var</span><span class="p">(</span><span class="s">"REDIS_URL"</span><span class="p">)</span>
    <span class="nf">.unwrap_or_else</span><span class="p">(|</span><span class="n">_</span><span class="p">|</span> <span class="s">"redis://localhost:6379"</span><span class="nf">.to_string</span><span class="p">());</span>

<span class="k">let</span> <span class="n">config</span> <span class="o">=</span> <span class="n">RedisConfig</span> <span class="p">{</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">redis_url</span><span class="p">,</span>
    <span class="o">..</span><span class="nn">Default</span><span class="p">::</span><span class="nf">default</span><span class="p">()</span>
<span class="p">};</span>

<span class="k">let</span> <span class="n">backend</span> <span class="o">=</span> <span class="nn">RedisBackend</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="memcached-backend-1">Memcached Backend</h3>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">use</span> <span class="nn">cache_kit</span><span class="p">::</span><span class="nn">backend</span><span class="p">::{</span><span class="n">MemcachedBackend</span><span class="p">,</span> <span class="n">MemcachedConfig</span><span class="p">};</span>

<span class="k">let</span> <span class="n">config</span> <span class="o">=</span> <span class="n">MemcachedConfig</span> <span class="p">{</span>
    <span class="n">servers</span><span class="p">:</span> <span class="nd">vec!</span><span class="p">[</span><span class="s">"localhost:11211"</span><span class="nf">.to_string</span><span class="p">()],</span>
    <span class="n">max_connections</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">min_connections</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">let</span> <span class="n">backend</span> <span class="o">=</span> <span class="nn">MemcachedBackend</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</code></pre></div></div>

<h4 id="memcached-configuration-options">Memcached Configuration Options</h4>

<table>
  <thead>
    <tr>
      <th>Field</th>
      <th>Type</th>
      <th>Default</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">servers</code></td>
      <td><code class="language-plaintext highlighter-rouge">Vec&lt;String&gt;</code></td>
      <td>Required</td>
      <td>Memcached server addresses</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">max_connections</code></td>
      <td><code class="language-plaintext highlighter-rouge">usize</code></td>
      <td><code class="language-plaintext highlighter-rouge">10</code></td>
      <td>Maximum connection pool size</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">min_connections</code></td>
      <td><code class="language-plaintext highlighter-rouge">usize</code></td>
      <td><code class="language-plaintext highlighter-rouge">2</code></td>
      <td>Minimum idle connections</td>
    </tr>
  </tbody>
</table>

<h4 id="multiple-memcached-servers">Multiple Memcached Servers</h4>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">config</span> <span class="o">=</span> <span class="n">MemcachedConfig</span> <span class="p">{</span>
    <span class="n">servers</span><span class="p">:</span> <span class="nd">vec!</span><span class="p">[</span>
        <span class="s">"memcached-01:11211"</span><span class="nf">.to_string</span><span class="p">(),</span>
        <span class="s">"memcached-02:11211"</span><span class="nf">.to_string</span><span class="p">(),</span>
        <span class="s">"memcached-03:11211"</span><span class="nf">.to_string</span><span class="p">(),</span>
    <span class="p">],</span>
    <span class="n">max_connections</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
    <span class="n">min_connections</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">let</span> <span class="n">backend</span> <span class="o">=</span> <span class="nn">MemcachedBackend</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</code></pre></div></div>

<hr />

<h2 id="ttl-configuration">TTL Configuration</h2>

<p>Configure time-to-live (TTL) for cached entries:</p>

<h3 id="global-ttl">Global TTL</h3>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">time</span><span class="p">::</span><span class="n">Duration</span><span class="p">;</span>

<span class="k">let</span> <span class="n">expander</span> <span class="o">=</span> <span class="nn">CacheExpander</span><span class="p">::</span><span class="nf">builder</span><span class="p">()</span>
    <span class="nf">.with_backend</span><span class="p">(</span><span class="n">backend</span><span class="p">)</span>
    <span class="nf">.with_ttl</span><span class="p">(</span><span class="nn">Duration</span><span class="p">::</span><span class="nf">from_secs</span><span class="p">(</span><span class="mi">3600</span><span class="p">))</span>  <span class="c1">// 1 hour</span>
    <span class="nf">.build</span><span class="p">();</span>
</code></pre></div></div>

<h3 id="per-operation-ttl">Per-Operation TTL</h3>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">time</span><span class="p">::</span><span class="n">Duration</span><span class="p">;</span>

<span class="n">expander</span><span class="nf">.builder</span><span class="p">()</span>
    <span class="nf">.with_strategy</span><span class="p">(</span><span class="nn">CacheStrategy</span><span class="p">::</span><span class="n">Refresh</span><span class="p">)</span>
    <span class="nf">.with_ttl</span><span class="p">(</span><span class="nn">Duration</span><span class="p">::</span><span class="nf">from_secs</span><span class="p">(</span><span class="mi">300</span><span class="p">))</span>  <span class="c1">// 5 minutes for this operation</span>
    <span class="nf">.execute</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">feeder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">repository</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="no-ttl-cache-forever">No TTL (Cache Forever)</h3>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Don't set TTL - cached entries never expire</span>
<span class="k">let</span> <span class="n">expander</span> <span class="o">=</span> <span class="nn">CacheExpander</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">backend</span><span class="p">);</span>
</code></pre></div></div>

<p><strong>Note:</strong> “Cache forever” is not recommended for production. Always set appropriate TTLs based on your data freshness requirements.</p>

<hr />

<h2 id="environment-based-configuration-1">Environment-Based Configuration</h2>

<p>Create a configuration module for your application:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">use</span> <span class="nn">cache_kit</span><span class="p">::</span><span class="nn">backend</span><span class="p">::{</span><span class="n">InMemoryBackend</span><span class="p">,</span> <span class="n">RedisBackend</span><span class="p">,</span> <span class="n">CacheBackend</span><span class="p">};</span>
<span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="n">env</span><span class="p">;</span>

<span class="k">pub</span> <span class="k">enum</span> <span class="n">Environment</span> <span class="p">{</span>
    <span class="n">Development</span><span class="p">,</span>
    <span class="n">Production</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span> <span class="n">Environment</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">from_env</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="k">match</span> <span class="nn">env</span><span class="p">::</span><span class="nf">var</span><span class="p">(</span><span class="s">"ENV"</span><span class="p">)</span><span class="nf">.as_deref</span><span class="p">()</span> <span class="p">{</span>
            <span class="nf">Ok</span><span class="p">(</span><span class="s">"production"</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="nn">Environment</span><span class="p">::</span><span class="n">Production</span><span class="p">,</span>
            <span class="n">_</span> <span class="k">=&gt;</span> <span class="nn">Environment</span><span class="p">::</span><span class="n">Development</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">pub</span> <span class="k">fn</span> <span class="nf">create_cache_backend</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span> <span class="n">CacheBackend</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">match</span> <span class="nn">Environment</span><span class="p">::</span><span class="nf">from_env</span><span class="p">()</span> <span class="p">{</span>
        <span class="nn">Environment</span><span class="p">::</span><span class="n">Development</span> <span class="k">=&gt;</span> <span class="p">{</span>
            <span class="nn">Box</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="nn">InMemoryBackend</span><span class="p">::</span><span class="nf">new</span><span class="p">())</span>
        <span class="p">}</span>
        <span class="nn">Environment</span><span class="p">::</span><span class="n">Production</span> <span class="k">=&gt;</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">redis_url</span> <span class="o">=</span> <span class="nn">env</span><span class="p">::</span><span class="nf">var</span><span class="p">(</span><span class="s">"REDIS_URL"</span><span class="p">)</span>
                <span class="nf">.expect</span><span class="p">(</span><span class="s">"REDIS_URL must be set in production"</span><span class="p">);</span>

            <span class="k">let</span> <span class="n">config</span> <span class="o">=</span> <span class="nn">cache_kit</span><span class="p">::</span><span class="nn">backend</span><span class="p">::</span><span class="n">RedisConfig</span> <span class="p">{</span>
                <span class="n">url</span><span class="p">:</span> <span class="n">redis_url</span><span class="p">,</span>
                <span class="n">max_connections</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
                <span class="n">min_connections</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                <span class="n">connection_timeout_secs</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="p">};</span>

            <span class="nn">Box</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="nn">RedisBackend</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="nf">.expect</span><span class="p">(</span><span class="s">"Failed to connect to Redis"</span><span class="p">))</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Usage:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[tokio::main]</span>
<span class="k">async</span> <span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span> <span class="nn">std</span><span class="p">::</span><span class="nn">error</span><span class="p">::</span><span class="n">Error</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">backend</span> <span class="o">=</span> <span class="nf">create_cache_backend</span><span class="p">();</span>
    <span class="k">let</span> <span class="n">expander</span> <span class="o">=</span> <span class="nn">CacheExpander</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">backend</span><span class="p">);</span>

    <span class="c1">// Your application logic</span>
    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="docker-compose-for-development">Docker Compose for Development</h2>

<p>Use Docker Compose to run Redis and Memcached locally:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">3.8"</span>

<span class="na">services</span><span class="pi">:</span>
  <span class="na">redis</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">redis:7-alpine</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">6379:6379"</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">redis_data:/data</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s">redis-server --appendonly yes</span>

  <span class="na">memcached</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">memcached:1.6-alpine</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">11211:11211"</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s">memcached -m </span><span class="m">64</span>

<span class="na">volumes</span><span class="pi">:</span>
  <span class="na">redis_data</span><span class="pi">:</span>
</code></pre></div></div>

<p>Start services:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose up <span class="nt">-d</span>
</code></pre></div></div>

<p>Test connections:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Redis</span>
redis-cli ping  <span class="c"># Should return: PONG</span>

<span class="c"># Memcached</span>
<span class="nb">echo</span> <span class="s2">"stats"</span> | nc localhost 11211  <span class="c"># Should return stats</span>
</code></pre></div></div>

<hr />

<h2 id="testing-configuration">Testing Configuration</h2>

<p>For unit and integration tests, use the InMemory backend:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[cfg(test)]</span>
<span class="k">mod</span> <span class="n">tests</span> <span class="p">{</span>
    <span class="k">use</span> <span class="k">super</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
    <span class="k">use</span> <span class="nn">cache_kit</span><span class="p">::</span><span class="nn">backend</span><span class="p">::</span><span class="n">InMemoryBackend</span><span class="p">;</span>

    <span class="nd">#[tokio::test]</span>
    <span class="k">async</span> <span class="k">fn</span> <span class="nf">test_user_caching</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Use InMemory backend for tests (no external dependencies)</span>
        <span class="k">let</span> <span class="n">backend</span> <span class="o">=</span> <span class="nn">InMemoryBackend</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">expander</span> <span class="o">=</span> <span class="nn">CacheExpander</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">backend</span><span class="p">);</span>

        <span class="c1">// Your test logic</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="test-isolation">Test Isolation</h3>

<p>Each test should create its own backend instance to avoid interference:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[tokio::test]</span>
<span class="k">async</span> <span class="k">fn</span> <span class="nf">test_cache_hit</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">backend</span> <span class="o">=</span> <span class="nn">InMemoryBackend</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>  <span class="c1">// Fresh instance</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">expander</span> <span class="o">=</span> <span class="nn">CacheExpander</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">backend</span><span class="p">);</span>
    <span class="c1">// Test logic</span>
<span class="p">}</span>

<span class="nd">#[tokio::test]</span>
<span class="k">async</span> <span class="k">fn</span> <span class="nf">test_cache_miss</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">backend</span> <span class="o">=</span> <span class="nn">InMemoryBackend</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>  <span class="c1">// Separate instance</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">expander</span> <span class="o">=</span> <span class="nn">CacheExpander</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">backend</span><span class="p">);</span>
    <span class="c1">// Test logic</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="production-checklist">Production Checklist</h2>

<p>Before deploying cache-kit to production:</p>

<ul class="task-list">
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" /><strong>Backend selected:</strong> Redis or Memcached for production</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" /><strong>Connection pooling configured:</strong> Set appropriate <code class="language-plaintext highlighter-rouge">max_connections</code></li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" /><strong>TTL policies defined:</strong> Set TTLs based on data freshness requirements</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" /><strong>Error handling implemented:</strong> Handle cache failures gracefully</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" /><strong>Monitoring enabled:</strong> Track cache hit/miss rates</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" /><strong>Environment variables set:</strong> <code class="language-plaintext highlighter-rouge">REDIS_URL</code> or <code class="language-plaintext highlighter-rouge">MEMCACHED_SERVERS</code></li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" /><strong>Fallback strategy:</strong> Application works if cache is unavailable</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" /><strong>Load tested:</strong> Verify performance under expected load</li>
</ul>

<hr />

<h2 id="common-configuration-patterns">Common Configuration Patterns</h2>

<h3 id="pattern-1-shared-cache-across-services">Pattern 1: Shared Cache Across Services</h3>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">sync</span><span class="p">::</span><span class="nb">Arc</span><span class="p">;</span>

<span class="k">let</span> <span class="n">backend</span> <span class="o">=</span> <span class="nn">RedisBackend</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="k">let</span> <span class="n">expander</span> <span class="o">=</span> <span class="nn">Arc</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="nn">CacheExpander</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">backend</span><span class="p">));</span>

<span class="c1">// Share expander across services</span>
<span class="k">let</span> <span class="n">user_service</span> <span class="o">=</span> <span class="nn">UserService</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="nn">Arc</span><span class="p">::</span><span class="nf">clone</span><span class="p">(</span><span class="o">&amp;</span><span class="n">expander</span><span class="p">));</span>
<span class="k">let</span> <span class="n">product_service</span> <span class="o">=</span> <span class="nn">ProductService</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="nn">Arc</span><span class="p">::</span><span class="nf">clone</span><span class="p">(</span><span class="o">&amp;</span><span class="n">expander</span><span class="p">));</span>
</code></pre></div></div>

<h3 id="pattern-2-multiple-cache-backends">Pattern 2: Multiple Cache Backends</h3>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// User cache (short TTL)</span>
<span class="k">let</span> <span class="n">user_backend</span> <span class="o">=</span> <span class="nn">RedisBackend</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">user_config</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="k">let</span> <span class="n">user_cache</span> <span class="o">=</span> <span class="nn">CacheExpander</span><span class="p">::</span><span class="nf">builder</span><span class="p">()</span>
    <span class="nf">.with_backend</span><span class="p">(</span><span class="n">user_backend</span><span class="p">)</span>
    <span class="nf">.with_ttl</span><span class="p">(</span><span class="nn">Duration</span><span class="p">::</span><span class="nf">from_secs</span><span class="p">(</span><span class="mi">300</span><span class="p">))</span>  <span class="c1">// 5 minutes</span>
    <span class="nf">.build</span><span class="p">();</span>

<span class="c1">// Product cache (long TTL)</span>
<span class="k">let</span> <span class="n">product_backend</span> <span class="o">=</span> <span class="nn">RedisBackend</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">product_config</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="k">let</span> <span class="n">product_cache</span> <span class="o">=</span> <span class="nn">CacheExpander</span><span class="p">::</span><span class="nf">builder</span><span class="p">()</span>
    <span class="nf">.with_backend</span><span class="p">(</span><span class="n">product_backend</span><span class="p">)</span>
    <span class="nf">.with_ttl</span><span class="p">(</span><span class="nn">Duration</span><span class="p">::</span><span class="nf">from_secs</span><span class="p">(</span><span class="mi">3600</span><span class="p">))</span>  <span class="c1">// 1 hour</span>
    <span class="nf">.build</span><span class="p">();</span>
</code></pre></div></div>

<h3 id="pattern-3-read-through-cache">Pattern 3: Read-Through Cache</h3>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">struct</span> <span class="n">CachedRepository</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">repository</span><span class="p">:</span> <span class="n">R</span><span class="p">,</span>
    <span class="n">cache</span><span class="p">:</span> <span class="n">CacheExpander</span><span class="o">&lt;</span><span class="n">RedisBackend</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">R</span><span class="p">:</span> <span class="n">DataRepository</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;&gt;</span> <span class="n">CachedRepository</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">get_user</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">id</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">str</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">feeder</span> <span class="o">=</span> <span class="n">UserFeeder</span> <span class="p">{</span>
            <span class="n">id</span><span class="p">:</span> <span class="n">id</span><span class="nf">.to_string</span><span class="p">(),</span>
            <span class="n">user</span><span class="p">:</span> <span class="nb">None</span><span class="p">,</span>
        <span class="p">};</span>

        <span class="c1">// Always use Refresh strategy for read-through</span>
        <span class="k">self</span><span class="py">.cache</span><span class="nf">.with</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">feeder</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">self</span><span class="py">.repository</span><span class="p">,</span> <span class="nn">CacheStrategy</span><span class="p">::</span><span class="n">Refresh</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

        <span class="nf">Ok</span><span class="p">(</span><span class="n">feeder</span><span class="py">.user</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="next-steps">Next Steps</h2>

<ul>
  <li>Learn about <a href="database-compatibility">Database &amp; ORM compatibility</a></li>
  <li>Explore <a href="backends">Cache backend options</a> in detail</li>
  <li>Review <a href="serialization">Serialization formats</a></li>
  <li>See the <a href="https://github.com/megamsys/cache-kit.rs/tree/main/examples/actixsqlx">Actix + SQLx example</a></li>
</ul>
